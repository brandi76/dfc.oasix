#!/usr/bin/perl
use CGI;
use DBI();

$html=new CGI;
print $html->header;
require "../oasix/manip_table.lib";
require "../oasix/outils_perl.lib";
require "./src/connect.src";


$debut=1;
$an=`/bin/date '+%Y'`;
chop($an);
if ($an==2015){$debut=5;}
$max=&get("select month(curdate())");
for ($i=$debut;$i<$max;$i++){
	$mois=$i;
	if ($mois<10){$mois='0'.$mois;}
	$premiere=$an.'-'.$mois.'-01';
	$mois++;
	$derniere=$an.'-'.$mois.'-01';
	$caht=&get("select sum(priht*qte) from corsica.panier_caisse,corsica.ticket_caisse where date>='$premiere' and date<'$derniere' and vendeuse!='sylvain' and ticket_date=date and ticket_vendeuse=vendeuse and ticket_pdv=pdv and no_cde=ticket_no and ticket_sup=0","af");
	$tab_caht[$i]=$caht;
	$achat=&get("select sum(prac*qte) from corsica.panier_caisse,corsica.ticket_caisse where date>='$premiere' and date<'$derniere' and vendeuse!='sylvain' and ticket_date=date and ticket_vendeuse=vendeuse and ticket_pdv=pdv and no_cde=ticket_no and ticket_sup=0","af");
	$marge=$caht-$achat;
	$tab_marge[$i]=$marge;
	$tab_loyer[$i]=&get("select loyer from corsica.exploitation where an='$an' and mois='$i'","af")+0;
	if ($tab_loyer[$i]==0){
	    print "$i";
		$mois=$i-1;
		$tab_loyer[$i]=&get("select loyer from corsica.exploitation where an='$an' and mois='$mois'")+0;
		&save("insert ignore into corsica.exploitation (an,mois,loyer) values ('$an','$i','$tab_loyer[$i]')","af");
		&save("update corsica.exploitation set loyer='$tab_loyer[$i]' where an='$an' and mois='$i'","af");

	}		
	$tab_salaire[$i]=&get("select salaire from corsica.exploitation where an='$an' and mois='$i'")+0;
	if ($tab_salaire[$i]==0){
		$mois=$i-1;
		$tab_salaire[$i]=&get("select salaire from corsica.exploitation where an='$an' and mois='$mois'")+0;
		&save("insert ignore into corsica.exploitation (an,mois,salaire) values ('$an','$i','$tab_salaire[$i]')","af");
		&save("update corsica.exploitation set salaire='$tab_salaire[$i]' where an='$an' and mois='$i'","af");
	}
	$tab_charge[$i]=$tab_salaire[$i]*0.682;
	$tab_logistique[$i]=&get("select logistique from corsica.exploitation where an='$an' and mois='$i'","af")+0;
	if ($tab_logistique[$i]==0){
		$mois=$i-1;
		$tab_logistique[$i]=&get("select logistique from corsica.exploitation where an='$an' and mois='$mois'","af")+0;
		&save("insert ignore into corsica.exploitation (an,mois,logistique) values ('$an','$i','$tab_logistique[$i]')","af");
		&save("update corsica.exploitation set logistique='$tab_logistique[$i]' where an='$an' and mois='$i'","af");
	}
}


print "<table cellspacing=0 border=1><tr><th>&nbsp;</th>";
for ($i=$debut;$i<$max;$i++){
	print "<th>".&cal($i)."</th>";
}
print "</tr>";
print "<tr><td>CAHT</td>";
for ($i=$debut;$i<$max;$i++){
	print "<td align=right>".$tab_caht[$i]."</td>";
}
print "</tr>";
print "<tr><td>Marge</td>";
for ($i=$debut;$i<$max;$i++){
	print "<td align=right>".$tab_marge[$i]."</td>";
}
print "</tr>";
print "<tr><td>%</td>";
for ($i=$debut;$i<$max;$i++){
	$pour=0;
	if ($tab_caht[$i]!=0){
		$pour=int($tab_marge[$i]*10000/$tab_caht[$i])/100;
	}	
	print "<td align=right>".$pour."%</td>";
}
print "</tr>";
print "<tr><td>Loyer+Charge</td>";
for ($i=$debut;$i<$max;$i++){
	print "<td align=right>".$tab_loyer[$i]."</td>";
}
print "</tr>";
print "<tr><td>Logistique</td>";
for ($i=$debut;$i<$max;$i++){
	print "<td align=right>".$tab_logistique[$i]."</td>";
}
print "</tr>";
print "<tr><td>Salaire net</td>";
for ($i=$debut;$i<$max;$i++){
	print "<td align=right>".$tab_salaire[$i]."</td>";
}
print "</tr>";
print "<tr><td>Charge sociales 68.2%</td>";
for ($i=$debut;$i<$max;$i++){
	print "<td align=right>".$tab_charge[$i]."</td>";
}
print "</tr>";
print "<tr><td>EBE</td>";
for ($i=$debut;$i<$max;$i++){
	$ebe=$tab_marge[$i]-$tab_loyer[$i]-$tab_salaire[$i]-$tab_charge[$i]-$tab_logistique[$i];
	print "<td align=right>".$ebe."</td>";
}
print "</tr>";

print "</table>";
