
$an_run=`/bin/date '+%Y'`;
chop($an_run);

$an=$html->param("an");
if ($an eq ""){
	print "<form>";
	&form_hidden();
	print "Année <input type=text name=an value=$an_run>";
	print "<br><input type=submit>";
	print "</form>";
}	
	
else {
	@tab_caht=();
	@tab_charge=();
	@tab_logistique=();
	@tab_loyer=();
	@tab_marge=();
	@tab_salaire=();
	print "<h3>$an Ajaccio</h3>";
	$pdv="Caisse 1";
	$debut=1;
	if ($an==2015){$debut=5;}
	if ($an==$an_run){$max=&get("select month(curdate())");}else {$max=13;}
	for ($i=$debut;$i<$max;$i++){
		$mois=$i;
		if ($mois<10){$mois='0'.$mois;}
		$premiere=$an.'-'.$mois.'-01';
		$mois++;
		$derniere=$an.'-'.$mois.'-01';
		$caht=&get("select sum(priht*qte) from corsica.panier_caisse,corsica.ticket_caisse where date>='$premiere' and date<'$derniere' and pdv='$pdv' and vendeuse!='sylvain' and ticket_date=date and ticket_vendeuse=vendeuse and ticket_pdv=pdv and no_cde=ticket_no and ticket_sup=0","af");
		$tab_caht[$i]=$caht;
		$achat=&get("select sum(prac*qte) from corsica.panier_caisse,corsica.ticket_caisse where date>='$premiere' and date<'$derniere' and pdv='$pdv' and vendeuse!='sylvain' and ticket_date=date and ticket_vendeuse=vendeuse and ticket_pdv=pdv and no_cde=ticket_no and ticket_sup=0","af");
		$marge=$caht-$achat;
		$tab_marge[$i]=$marge;
		$tab_loyer[$i]=&get("select loyer from corsica.exploitation where pdv='$pdv' and an='$an' and mois='$i'","af")+0;
		if ($tab_loyer[$i]==0){
			# print "$i";
			$mois=$i-1;
			$tab_loyer[$i]=&get("select loyer from corsica.exploitation where pdv='$pdv' and an='$an' and mois='$mois'")+0;
			&save("insert ignore into corsica.exploitation (pdv,an,mois,loyer) values ('$pdv','$an','$i','$tab_loyer[$i]')","af");
			&save("update corsica.exploitation set loyer='$tab_loyer[$i]' where pdv='$pdv' and an='$an' and mois='$i'","af");
		}		
		$tab_salaire[$i]=&get("select salaire from corsica.exploitation where  pdv='$pdv' and an='$an' and mois='$i'")+0;
		if ($tab_salaire[$i]==0){
			$mois=$i-1;
			$tab_salaire[$i]=&get("select salaire from corsica.exploitation where  pdv='$pdv' and an='$an' and mois='$mois'")+0;
			&save("insert ignore into corsica.exploitation (pdv,an,mois,salaire) values ('$pdv','$an','$i','$tab_salaire[$i]')","af");
			&save("update corsica.exploitation set salaire='$tab_salaire[$i]' where pdv='$pdv' and an='$an' and mois='$i'","af");
		}
		$tab_charge[$i]=$tab_salaire[$i]*0.682;
		$tab_logistique[$i]=&get("select logistique from corsica.exploitation where pdv='$pdv' and an='$an' and mois='$i'","af")+0;
		if ($tab_logistique[$i]==0){
			$mois=$i-1;
			$tab_logistique[$i]=&get("select logistique from corsica.exploitation where pdv='$pdv' and an='$an' and mois='$mois'","af")+0;
			&save("insert ignore into corsica.exploitation (pdv,an,mois,logistique) values ('$pdv','$an','$i','$tab_logistique[$i]')","af");
			&save("update corsica.exploitation set logistique='$tab_logistique[$i]' where pdv='$pdv' and an='$an' and mois='$i'","af");
		}
	}

	print "<table cellspacing=0 border=1><tr><th>&nbsp;</th>";
	for ($i=$debut;$i<$max;$i++){
		print "<th>".&cal($i)."</th>";
	}
	print "<th>Total</th>";
	print "</tr>";
	print "<tr><td>CAHT</td>";
	$total_ligne=0;
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_caht[$i]."</td>";
		$total_ligne+=$tab_caht[$i];
	}
	print "<td align=right>".$total_ligne."</td>";
	print "</tr>";
	print "<tr><td>Marge</td>";
	$total_ligne=0;
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_marge[$i]."</td>";
		$total_ligne+=$tab_marge[$i];
	}
	print "<td align=right>".$total_ligne."</td>";
	print "</tr>";
	print "<tr><td>%</td>";
	for ($i=$debut;$i<$max;$i++){
		$pour=0;
		if ($tab_caht[$i]!=0){
			$pour=int($tab_marge[$i]*10000/$tab_caht[$i])/100;
		}	
		print "<td align=right>".$pour."%</td>";
	}
	print "</tr>";
	print "<tr><td>Loyer+Charge</td>";
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_loyer[$i]."</td>";
	}
	print "</tr>";
	print "<tr><td>Logistique</td>";
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_logistique[$i]."</td>";
	}
	print "</tr>";
	print "<tr><td>Salaire net</td>";
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_salaire[$i]."</td>";
	}
	print "</tr>";
	print "<tr><td>Charge sociales 68.2%</td>";
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_charge[$i]."</td>";
	}
	print "</tr>";
	print "<tr><td>EBE</td>";
	for ($i=$debut;$i<$max;$i++){
		$ebe=$tab_marge[$i]-$tab_loyer[$i]-$tab_salaire[$i]-$tab_charge[$i]-$tab_logistique[$i];
		print "<td align=right>".$ebe."</td>";
	}
	print "</tr>";
	print "</table>";
	
	
	@tab_caht=();
	@tab_charge=();
	@tab_logistique=();
	@tab_loyer=();
	@tab_marge=();
	@tab_salaire=();
	print "<h3>$an Bastia</h3>";
	$pdv="Caisse 2";
	$debut=1;
	if ($an==2015){$debut=5;}
	if ($an==$an_run){$max=&get("select month(curdate())");}else {$max=13;}
	for ($i=$debut;$i<$max;$i++){
		$mois=$i;
		if ($mois<10){$mois='0'.$mois;}
		$premiere=$an.'-'.$mois.'-01';
		$mois++;
		$derniere=$an.'-'.$mois.'-01';
		$caht=&get("select sum(priht*qte) from corsica.panier_caisse,corsica.ticket_caisse where date>='$premiere' and date<'$derniere' and pdv='$pdv' and vendeuse!='sylvain' and ticket_date=date and ticket_vendeuse=vendeuse and ticket_pdv=pdv and no_cde=ticket_no and ticket_sup=0","af");
		$tab_caht[$i]=$caht;
		$achat=&get("select sum(prac*qte) from corsica.panier_caisse,corsica.ticket_caisse where date>='$premiere' and date<'$derniere' and pdv='$pdv' and vendeuse!='sylvain' and ticket_date=date and ticket_vendeuse=vendeuse and ticket_pdv=pdv and no_cde=ticket_no and ticket_sup=0","af");
		$marge=$caht-$achat;
		$tab_marge[$i]=$marge;
		$tab_loyer[$i]=&get("select loyer from corsica.exploitation where pdv='$pdv' and an='$an' and mois='$i'","af")+0;
		if ($tab_loyer[$i]==0){
			# print "$i";
			$mois=$i-1;
			$tab_loyer[$i]=&get("select loyer from corsica.exploitation where pdv='$pdv' and an='$an' and mois='$mois'")+0;
			&save("insert ignore into corsica.exploitation (pdv,an,mois,loyer) values ('$pdv','$an','$i','$tab_loyer[$i]')","af");
			&save("update corsica.exploitation set loyer='$tab_loyer[$i]' where pdv='$pdv' and an='$an' and mois='$i'","af");
		}		
		$tab_salaire[$i]=&get("select salaire from corsica.exploitation where  pdv='$pdv' and an='$an' and mois='$i'")+0;
		if ($tab_salaire[$i]==0){
			$mois=$i-1;
			$tab_salaire[$i]=&get("select salaire from corsica.exploitation where  pdv='$pdv' and an='$an' and mois='$mois'")+0;
			&save("insert ignore into corsica.exploitation (pdv,an,mois,salaire) values ('$pdv','$an','$i','$tab_salaire[$i]')","af");
			&save("update corsica.exploitation set salaire='$tab_salaire[$i]' where pdv='$pdv' and an='$an' and mois='$i'","af");
		}
		$tab_charge[$i]=$tab_salaire[$i]*0.682;
		$tab_logistique[$i]=&get("select logistique from corsica.exploitation where pdv='$pdv' and an='$an' and mois='$i'","af")+0;
		if ($tab_logistique[$i]==0){
			$mois=$i-1;
			$tab_logistique[$i]=&get("select logistique from corsica.exploitation where pdv='$pdv' and an='$an' and mois='$mois'","af")+0;
			&save("insert ignore into corsica.exploitation (pdv,an,mois,logistique) values ('$pdv','$an','$i','$tab_logistique[$i]')","af");
			&save("update corsica.exploitation set logistique='$tab_logistique[$i]' where pdv='$pdv' and an='$an' and mois='$i'","af");
		}
	}

	print "<table cellspacing=0 border=1><tr><th>&nbsp;</th>";
	for ($i=$debut;$i<$max;$i++){
		print "<th>".&cal($i)."</th>";
	}
	print "<th>Total</th>";
	print "</tr>";
	print "<tr><td>CAHT</td>";
	$total_ligne=0;
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_caht[$i]."</td>";
		$total_ligne+=$tab_caht[$i];
	}
	print "<td align=right>".$total_ligne."</td>";
	print "</tr>";
	print "<tr><td>Marge</td>";
	$total_ligne=0;
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_marge[$i]."</td>";
		$total_ligne+=$tab_marge[$i];
	}
	print "<td align=right>".$total_ligne."</td>";
	print "</tr>";
	print "<tr><td>%</td>";
	for ($i=$debut;$i<$max;$i++){
		$pour=0;
		if ($tab_caht[$i]!=0){
			$pour=int($tab_marge[$i]*10000/$tab_caht[$i])/100;
		}	
		print "<td align=right>".$pour."%</td>";
	}
	print "</tr>";
	print "<tr><td>Loyer+Charge</td>";
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_loyer[$i]."</td>";
	}
	print "</tr>";
	print "<tr><td>Logistique</td>";
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_logistique[$i]."</td>";
	}
	print "</tr>";
	print "<tr><td>Salaire net</td>";
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_salaire[$i]."</td>";
	}
	print "</tr>";
	print "<tr><td>Charge sociales 68.2%</td>";
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_charge[$i]."</td>";
	}
	print "</tr>";
	print "<tr><td>EBE</td>";
	for ($i=$debut;$i<$max;$i++){
		$ebe=$tab_marge[$i]-$tab_loyer[$i]-$tab_salaire[$i]-$tab_charge[$i]-$tab_logistique[$i];
		print "<td align=right>".$ebe."</td>";
	}
	print "</tr>";
	print "</table>";
	
	@tab_caht=();
	@tab_charge=();
	@tab_logistique=();
	@tab_loyer=();
	@tab_marge=();
	@tab_salaire=();
	print "<h3>$an Douala</h3>";
	$debut=1;
	if ($an==2015){$debut=5;}
	if ($an==$an_run){$max=&get("select month(curdate())");}else {$max=13;}
	for ($i=$debut;$i<$max;$i++){
		$mois=$i;
		if ($mois<10){$mois='0'.$mois;}
		$premiere=$an.'-'.$mois.'-01';
		$mois++;
		$derniere=$an.'-'.$mois.'-01';
		$caht=&get("select sum(ticket_montant) from cameshop.ticket_caisse_js where ticket_date>='$premiere' and ticket_date<'$derniere' and ticket_vendeuse!='sylvain' and ticket_sup=0","af");
		$tab_caht[$i]=$caht;
		$achat=&get("select sum(prac*qte) from cameshop.panier_caisse,cameshop.ticket_caisse_js where date>='$premiere' and date<'$derniere' and vendeuse!='sylvain' and ticket_date=date and ticket_vendeuse=vendeuse and ticket_pdv=pdv and no_cde=ticket_no and ticket_sup=0","af");
		$marge=$caht-$achat;
		$tab_marge[$i]=$marge;
		$tab_loyer[$i]=&get("select loyer from cameshop.exploitation where an='$an' and mois='$i'","af")+0;
		if ($tab_loyer[$i]==0){
			# print "$i";
			$mois=$i-1;
			$tab_loyer[$i]=&get("select loyer from cameshop.exploitation where an='$an' and mois='$mois'")+0;
			&save("insert ignore into cameshop.exploitation (an,mois,loyer) values ('$an','$i','$tab_loyer[$i]')","af");
			&save("update cameshop.exploitation set loyer='$tab_loyer[$i]' where an='$an' and mois='$i'","af");
		}		
		$tab_salaire[$i]=&get("select salaire from cameshop.exploitation where an='$an' and mois='$i'")+0;
		if ($tab_salaire[$i]==0){
			$mois=$i-1;
			$tab_salaire[$i]=&get("select salaire from cameshop.exploitation where an='$an' and mois='$mois'")+0;
			&save("insert ignore into cameshop.exploitation (an,mois,salaire) values ('$an','$i','$tab_salaire[$i]')","af");
			&save("update cameshop.exploitation set salaire='$tab_salaire[$i]' where an='$an' and mois='$i'","af");
		}
		$tab_charge[$i]=$tab_salaire[$i]*0.682;
		$tab_logistique[$i]=&get("select logistique from cameshop.exploitation where an='$an' and mois='$i'","af")+0;
		if ($tab_logistique[$i]==0){
			$mois=$i-1;
			$tab_logistique[$i]=&get("select logistique from cameshop.exploitation where an='$an' and mois='$mois'","af")+0;
			&save("insert ignore into cameshop.exploitation (an,mois,logistique) values ('$an','$i','$tab_logistique[$i]')","af");
			&save("update cameshop.exploitation set logistique='$tab_logistique[$i]' where an='$an' and mois='$i'","af");
		}
	}

	print "<table cellspacing=0 border=1><tr><th>&nbsp;</th>";
	for ($i=$debut;$i<$max;$i++){
		print "<th>".&cal($i)."</th>";
	}
	print "<th>Total</th>";
	print "</tr>";
	print "<tr><td>CAHT</td>";
	$total_ligne=0;
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_caht[$i]."</td>";
		$total_ligne+=$tab_caht[$i];
	}
	print "<td align=right>".$total_ligne."</td>";
	print "</tr>";
	print "<tr><td>Marge</td>";
	$total_ligne=0;
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_marge[$i]."</td>";
		$total_ligne+=$tab_marge[$i];
	}
	print "<td align=right>".$total_ligne."</td>";
	print "</tr>";
	print "<tr><td>%</td>";
	for ($i=$debut;$i<$max;$i++){
		$pour=0;
		if ($tab_caht[$i]!=0){
			$pour=int($tab_marge[$i]*10000/$tab_caht[$i])/100;
		}	
		print "<td align=right>".$pour."%</td>";
	}
	print "</tr>";
	print "<tr><td>Loyer+Charge</td>";
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_loyer[$i]."</td>";
	}
	print "</tr>";
	print "<tr><td>Logistique</td>";
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_logistique[$i]."</td>";
	}
	print "</tr>";
	print "<tr><td>Salaire net</td>";
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_salaire[$i]."</td>";
	}
	print "</tr>";
	print "<tr><td>Charge sociales 68.2%</td>";
	for ($i=$debut;$i<$max;$i++){
		print "<td align=right>".$tab_charge[$i]."</td>";
	}
	print "</tr>";
	print "<tr><td>EBE</td>";
	for ($i=$debut;$i<$max;$i++){
		$ebe=$tab_marge[$i]-$tab_loyer[$i]-$tab_salaire[$i]-$tab_charge[$i]-$tab_logistique[$i];
		print "<td align=right>".$ebe."</td>";
	}
	print "</tr>";
	print "</table>";

}
;1